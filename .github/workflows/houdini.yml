
name: Houdini

on:
  push:
    branches:
      - 'master'
      - 'feature/**'
      - 'pr/**'
    paths-ignore:
      - 'CHANGES'
      - 'doc/**'
      - 'openvdb_maya/**'
      - 'pendingchanges/**'
      - '**.md'
  pull_request:
    branches:
      - '**'
    paths-ignore:
      - 'CHANGES'
      - 'doc/**'
      - 'openvdb_maya/**'
      - 'pendingchanges/**'
      - '**.md'
  schedule:
    # run this workflow every day at 7am UTC
    - cron:  '0 7 * * *'
  workflow_dispatch:

jobs:
  checkcache:
    # Check that a valid Houdini cache exists. This isn't run on the ASWF repo
    # as wel always expect a cache to exist there. Note that this required the
    # cache to be fetched but that is currently trivial. See
    # https://github.com/actions/toolkit/issues/500
    if: github.repository_owner != 'AcademySoftwareFoundation'
    name: Verify Houdini Cache
    runs-on: ubuntu-latest
    outputs:
      HOUDINI_CACHE: ${{ steps.check.outputs.HOUDINI_CACHE }}
    steps:
    - uses: actions/cache@v2
      id: cache
      with:
        path: hou
        key: vdb1-houdini${{ matrix.config.hou }}-${{ hashFiles('hou/hou.tar.gz') }}
        restore-keys: vdb1-houdini${{ matrix.config.hou }}-
    - id: check
      run: echo "::set-output name=HOUDINI_CACHE::${{ steps.cache.outputs.cache-hit == 'true' }}"
    - name: Skip Next Jobs
      if: steps.check.outputs.HOUDINI_CACHE != 'true'
      run: echo "No Houdini Cache available, skipping jobs..."

  linux-vfx-houdini:
    needs: [checkcache]
    if: >
      ${{ needs.checkcache.outputs.HOUDINI_CACHE == 'true' ||
          github.repository_owner == 'AcademySoftwareFoundation' }}
    runs-on: ubuntu-latest
    name: hou:${{ matrix.config.hou }}-vfx:${{ matrix.config.image }}-cxx:${{ matrix.config.cxx }}
    container:
      image: aswf/ci-base:${{ matrix.config.image }}
    env:
      CXX: ${{ matrix.config.cxx }}
    strategy:
      matrix:
        config:
          # build against VFX Ref 2018 even though it's unsupported, just to make sure that we test Boost 1.61
          - { cxx: clang++, image: '2018', hou: '18_0', j: '2', build: 'Release', components: 'core,hou,bin,python,test,axcore,axbin,axtest', disable_checks: 'ON' }
          - { cxx: clang++, image: '2019', hou: '18_0', j: '2', build: 'Release', components: 'core,hou,bin,python,test,axcore,axbin,axtest', disable_checks: 'OFF' }
          - { cxx: clang++, image: '2020', hou: '18_5', j: '2', build: 'Release', components: 'core,hou,bin,python,test,axcore,axbin,axtest', disable_checks: 'OFF' }
          - { cxx: clang++, image: '2020', hou: '18_5', j: '2', build: 'Debug', components: 'core,hou', disable_checks: 'OFF' }
          - { cxx: g++,     image: '2020', hou: '18_5', j: '1', build: 'Release', components: 'core,hou', disable_checks: 'OFF' }
      fail-fast: false
    steps:
    - uses: actions/checkout@v2
    - name: fetch_houdini
      uses: actions/cache@v2
      with:
        path: hou
        key: vdb1-houdini${{ matrix.config.hou }}-${{ hashFiles('hou/hou.tar.gz') }}
        restore-keys: vdb1-houdini${{ matrix.config.hou }}-
    - name: validate_houdini
      run: test -f "hou/hou.tar.gz"
    - name: install_houdini
      run: mv hou/hou.tar.gz . && tar -vxzf hou.tar.gz
    - name: install_cmake
      run: ./ci/install_cmake.sh 3.12.0
    - name: install_gtest
      run: ./ci/install_gtest.sh 1.10.0
    - name: build
      shell: bash
      run: >
        cd hou && source houdini_setup_bash && cd - &&
        ./ci/build.sh -v
        -j ${{ matrix.config.j }}
        --build-type=${{ matrix.config.build }}
        --components="${{ matrix.config.components }}"
        --cargs=\"-DOPENVDB_BUILD_HOUDINI_ABITESTS=ON -DOPENVDB_HOUDINI_INSTALL_PREFIX=/tmp -DDISABLE_DEPENDENCY_VERSION_CHECKS=${{ matrix.config.disable_checks }}\"
    - name: test
      run: cd build && ctest -V
